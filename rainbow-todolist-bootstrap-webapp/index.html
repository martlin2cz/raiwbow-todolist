<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rainbow todolist</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.1.2/datatables.min.css" rel="stylesheet">

<!--    <script src="js/scripts.js"></script>-->
</head>
<body>
<h1>Rainbow todolist</h1>
<div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="rainbow-todolist-status-toast">
  <div class="toast-header">
    <strong class="mr-auto">Saved</strong>
    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="toast-body">
    Done?
  </div>
</div>

<table id="rainbow-tasks-table">
    <thead>
    <tr>
        <th>Task text</th>
    </tr>
    </thead>
</table>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/2.1.2/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.1.2/js/dataTables.bootstrap5.min.js"></script>
<script type="module">

    // var data = {"result": [{"id":"f164ae90-1ef0-4803-a28c-1b4f6a590b63","text":"Try the app"}]}
    const PORT = 5000

    var rainbowTasksDatatable = new DataTable("#rainbow-tasks-table", {

        ajax: {
            dataSrc: 'result',
            url: "http://localhost:" + PORT + "/api/v0.2/rainbowtodolist/tasks"
        },
        columns: [
            {
                data: 'text',
                render: function (data, type) {
                    if (type != 'display') {
                        return data;
                    }

                    return '<form method="PATCH" class="rainbow-task-text-edit-form">'
                            + '<input type="text" name="text" value="' + data + '" class="rainbow-task-text-edit-input">'
                            + '</form>';

                }
            }
        ],
        createdRow: function (row, data, index) {
            var id = data["id"]
            $(row).find("form.rainbow-task-text-edit-form").submit(function(event) {
                submitUpdatedTextForm(event, id);
            });
            $(row).find(".rainbow-task-text-edit-input").change(function(event) {
                submitUpdatedText(event, id);
            });
        },
        info: false,
        ordering: false,
        paging: false,
        searching: false
       });

    function submitUpdatedTextForm(event, id) {
        var form = event.target
        var text = form["text"].value

        doSaveUpdatedText(id, text);

        event.preventDefault();
    }

    function submitUpdatedText(event, id) {
        var text = event.target.value

        doSaveUpdatedText(id, text);

        event.preventDefault();
    }

    function doSaveUpdatedText(id, text) {
        if (text) {
            executeAjax("PATCH", "tasks/" + id, {"text": text});
        } else {
            executeAjax("DELETE", "tasks/" + id, {});
        }
    }

    function executeAjax(method, relativeURI, data) {
        var uri = "http://localhost:" + PORT + "/api/v0.2/rainbowtodolist/" + relativeURI;
        console.debug(method, uri, data);

        $.ajax({
          type: method,
          url: uri,
          data: data,
          dataType: "json",
          encode: true,
        }).done(function (data) {
            rainbowTasksDatatable.ajax.reload();
            $("#rainbow-todolist-status-toast").toast("show");
        }).fail(function (data) {
            rainbowTasksDatatable.ajax.reload();
            $("#rainbow-todolist-status-toast").toast("show");
        });
    }
</script>
</body>
</html>
